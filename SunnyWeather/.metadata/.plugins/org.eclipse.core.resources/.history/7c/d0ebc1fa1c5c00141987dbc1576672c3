package com.ustcweather.amarishappilees.city;

import android.app.Application;
import android.content.Context;

import org.androidannotations.annotations.AfterInject;
import org.androidannotations.annotations.EApplication;

import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;

import com.ustcweather.amarishappilees.city.CitySaxParseHandler;
import com.ustcweather.amarishappilees.city.WeatherModel;
import com.ustcweather.amarishappilees.city.AreaModel;
import com.ustcweather.amarishappilees.city.ProvicneModel;
import com.ustcweather.amarishappilees.city.FileUtil;
import com.ustcweather.amarishappilees.city.LogUtil;

/**
 * Created by Ho on 2014/6/25.
 */

@EApplication
public class App extends Application {

    protected final static String TAG = "App";

    private static Context mContext;

    /** 鍩庡競鍒楄〃 */
    private static List<ProvicneModel> mProvicneModels;
    private static List<AreaModel> mAreaModels;
    public static WeatherModel mCurWeatherModel;
    private static int mCurWeatherIndex;

    @AfterInject
    void init() {

        this.mContext = getApplicationContext();
        this.mAreaModels = new ArrayList<AreaModel>();
        this.mCurWeatherIndex = 0;
        this.initMyArea();
        this.initProvicneModels();
    }

    public static Context getContext() {
        return mContext;
    }

    /**
     * 鍒濆鍖栧煄甯傚垪琛�
     */
    private void initProvicneModels() {
        try {
            InputStream in = getAssets().open(Const.FILE_CITY_NAME);
            mProvicneModels = CitySaxParseHandler.getProvicneModel(in);
            LogUtil.i(TAG, mProvicneModels.toString());
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    public static List<ProvicneModel> getProvicneModels() {
        return mProvicneModels;
    }

    /**
     * 鍒濆鍖栨垜鐨勫煄甯�
     */
    private void initMyArea() {
        try {
            List<AreaModel> models = (List<AreaModel>) FileUtil.readObjsFromFile(Const.FILE_MY_AREA);
            if (models != null) {
                mAreaModels.addAll(models);
                LogUtil.i(TAG, mAreaModels.get(0).getCityName());
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void setCurCityIndex(int index) {
        mCurWeatherIndex = index;
    }

    public static int getCurCityIndex() {
        return mCurWeatherIndex;
    }

    /**
     * 娣诲姞鎴戠殑鍩庡競
     * @param model
     * @return
     */
    public static String addMyArea(AreaModel model) {
        if (model == null) {
            LogUtil.i(TAG, "null");
            return null;
        }

        if (mAreaModels.size() >= 5) {
            return getContext().getString(R.string.city_exceed_num);
        } else {
            for (AreaModel areaModel : mAreaModels) {
                if (areaModel.getCityId().equals(model.getCityId())) {
                    return getContext().getString(R.string.city_already_exists);
                }
            }
            //娣诲姞鍒扮涓�浣�
            mAreaModels.add(0, model);
            // 閲嶆柊淇濆瓨鏂囦欢
            FileUtil.writeObjsToFile(mAreaModels, Const.FILE_MY_AREA, Context.MODE_PRIVATE);
            // 杩斿洖娣诲姞鍩庡競缁撴灉淇℃伅
            return getContext().getString(R.string.city_add_success);
        }
    }

    /**
     * 鍒犻櫎鍩庡競淇℃伅
     * @param position
     * @return
     */
    public static AreaModel removeMyArea(int position) {
        // 鍒犻櫎鏁版嵁
        AreaModel model = mAreaModels.remove(position);
        // 閲嶆柊淇濆瓨鏂囦欢
        FileUtil.writeObjsToFile(mAreaModels, Const.FILE_MY_AREA, Context.MODE_PRIVATE);
        return model;
    }
    public static boolean removeMyArea(AreaModel areaModel) {
        // 鍒犻櫎鏁版嵁
        boolean is = mAreaModels.remove(areaModel);
        // 閲嶆柊淇濆瓨鏂囦欢
        FileUtil.writeObjsToFile(mAreaModels, Const.FILE_MY_AREA, Context.MODE_PRIVATE);
        return is;
    }

    public static List<AreaModel> getMyArea() {
        return mAreaModels;
    }
}
